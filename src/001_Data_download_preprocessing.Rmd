---
title: "001_Data_download_preprocessing"
author: "Luise A. Seeker"
date: "2025-09-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, eval=FALSE}
# Install RNAseqEr library from GitHub

devtools::install_github("LASeeker/RNAseqEr")

```
```

load libraries
```{r}
library(Seurat)
library(dplyr)
library(cellxgene.census)
library(RNAseqEr)
library("readr")
library("httr")
library("stringr")
library("rjson")


```




```{r}
collection_id <- "1ca90a2d-2943-483d-b678-b809bf464c30"
dataset_id <- "e6c31d25-fdb2-434a-b329-aa0476fc701d"
```

```{r}
domain_name <- "cellxgene.cziscience.com"
site_url <- str_interp("https://${domain_name}")
api_url_base <- str_interp("https://api.${domain_name}")
datasets_path <- str_interp("/curation/v1/datasets")
datasets_url <- str_interp("${api_url_base}${datasets_path}")
res <- GET(url=datasets_url, `Content-Type`="application/json")
stop_for_status(res)
res_content <- content(res)
print(res_content)
```


```{r}
# Open the census
census <- open_soma()

# Define filter criteria for SEA-AD oligodendrocytes
obs_filters <- list(
  # Filter for SEA-AD dataset
  dataset_id = "b963f0a5-8cd4-4fa1-92de-5c9d2c7b3857",  # SEA-AD dataset ID
  
  # Filter for oligodendrocytes
  cell_type = "oligodendrocyte",
  
  # Filter for specific brain regions (MTG and DLPFC)
  tissue_general = c("middle temporal gyrus", "dorsolateral prefrontal cortex"),
  
  # Filter for specific Braak stages
  # Note: The exact column name may vary - check obs metadata first
  braak_stage = c("Braak III", "Braak VI", "Reference")
)

# Alternative approach if braak_stage column has different naming
# You might need to check the actual column names in the dataset first
print("Checking available metadata columns...")
obs_df <- census$get("census_data")$obs$read(
  value_filter = paste0("dataset_id == '", obs_filters$dataset_id, "'"),
  column_names = NULL  # Get all columns to inspect
)$concat()$to_data_frame()

# Print unique values for braak-related columns (adjust column name as needed)
braak_columns <- grep("braak|stage", colnames(obs_df), ignore.case = TRUE, value = TRUE)
print(paste("Braak-related columns found:", paste(braak_columns, collapse = ", ")))

# Check unique values in these columns
for (col in braak_columns) {
  if (col %in% colnames(obs_df)) {
    print(paste("Unique values in", col, ":"))
    print(unique(obs_df[[col]]))
  }
}

# Now extract the filtered data
# Method 1: Using census query (recommended for large datasets)
query_filters <- paste0(
  "dataset_id == 'b963f0a5-8cd4-4fa1-92de-5c9d2c7b3857' and ",
  "cell_type == 'oligodendrocyte' and ",
  "tissue_general in ['middle temporal gyrus', 'dorsolateral prefrontal cortex']"
  # Add braak stage filter here once you confirm the column name
  # " and braak_stage in ['Braak III', 'Braak VI', 'Reference']"
)

# Get the filtered cell metadata
filtered_obs <- census$get("census_data")$obs$read(
  value_filter = query_filters,
  column_names = c(
    "soma_joinid", "cell_type", "tissue_general", 
    "dataset_id", "donor_id", "suspension_type",
    braak_columns  # Include braak-related columns
  )
)$concat()$to_data_frame()

# Further filter by Braak stage if column name is different
# Adjust this based on the actual column name found above
if ("braak_stage" %in% colnames(filtered_obs)) {
  filtered_obs <- filtered_obs %>%
    filter(braak_stage %in% c("Braak III", "Braak VI", "Reference"))
} else if (length(braak_columns) > 0) {
  # Use the first braak-related column found
  braak_col <- braak_columns[1]
  print(paste("Using column:", braak_col, "for Braak stage filtering"))
  # You'll need to adjust the values based on what you found above
  # filtered_obs <- filtered_obs %>%
  #   filter(!!sym(braak_col) %in% c("III", "VI", "Reference"))
}

print(paste("Found", nrow(filtered_obs), "oligodendrocytes matching criteria"))
print("Sample breakdown:")
print(table(filtered_obs$tissue_general))

# Get the gene expression data for these cells
cell_ids <- filtered_obs$soma_joinid

# Method 2: Extract expression matrix
# This might take a while for large numbers of cells
expression_matrix <- census$get("census_data")$X$read(
  obs_joinids = cell_ids,
  var_joinids = NULL  # Get all genes, or specify specific gene IDs
)$tables()$to_data_frame()

# Convert to a more usable format (Seurat object)
# First get gene metadata
var_df <- census$get("census_data")$var$read(
  column_names = c("soma_joinid", "feature_id", "feature_name")
)$concat()$to_data_frame()

# Create Seurat object
# Note: You might need to reshape the expression matrix depending on its format
seurat_obj <- CreateSeuratObject(
  counts = expression_matrix,  # May need transposition/reshaping
  meta.data = filtered_obs
)
```


```{r}
              

# Open the Census and define the filter
census <- open_soma(census_version = "2025-01-30")
on.exit(census$close(), add = TRUE) # Ensures connection is closed

# Filter for the specific dataset ID
# We use the 'dataset_id == ...' syntax in the value_filter
dataset_filter <- paste0("dataset_id == '", dataset_id, "'")

# Fetch the data into a Seurat object
# Note: You must also specify the organism. In this example, 'Homo sapiens' is assumed.
mtg_srt <- get_seurat(
  census,
  organism = "Homo sapiens",
  obs_value_filter = dataset_filter,
  measurement_name = "RNA"
)

```

```{r}
# Open the Census
census <- open_soma()
on.exit(census$close(), add = TRUE)

# Access the obs (observations) data frame
obs_soma <- census$ms$get("RNA")$obs

# Read the dataset_id column
dataset_ids <- obs_soma$read(column_names = "dataset_id")$concat()
unique_datasets <- unique(dataset_ids$dataset_id)

# Check if your dataset ID exists
print(ol_mtg_dat_id %in% unique_datasets)
```